<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Marketing Alchemist â€” Bottle Fill (C3)</title>

<style>
  :root { color-scheme: dark; }
  body {
    margin: 0;
    background: #0b0f14;
    color: #e6edf3;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }

  #wrap {
    display: flex;
    gap: 16px;
    padding: 16px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .panel {
    width: min(820px, calc(100vw - 32px));
    border: 1px solid #243244;
    border-radius: 14px;
    background: #0f1621;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
  }

  .panel-header {
    padding: 12px 14px;
    border-bottom: 1px solid #243244;
    background: #0e1726;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }

  .panel-body { padding: 14px; }

  .pill {
    border: 1px solid #243244;
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 12px;
    background: #0b0f14;
    opacity: .9;
  }

  /* DM */
  .dm-line { margin: 8px 0; line-height: 1.4; }
  .dm-title { font-weight: 900; font-size: 18px; }

  /* Board */
  .board {
    display: grid;
    gap: 12px;
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }
  @media (max-width: 820px) {
    .board { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }

  .bottle {
    border: 1px solid #243244;
    border-radius: 14px;
    background: #0b0f14;
    padding: 8px;
    min-height: 160px;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    gap: 6px;
    cursor: pointer;
    user-select: none;
  }
  .bottle.selected { outline: 2px solid rgba(255,255,255,.35); }
  .bottle.locked { opacity: .6; }

  .slot {
    height: 18px;
    border-radius: 8px;
    border: 1px solid #1b2a3c;
    position: relative;
    overflow: hidden;
  }
  .fill {
    position: absolute;
    inset: 0;
  }

  .footer {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 8px;
  }

  button {
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid #243244;
    background: #101b2b;
    color: #e6edf3;
    font-weight: 700;
    cursor: pointer;
  }
</style>
</head>

<body>
<div id="wrap">

  <!-- DM PANEL -->
  <div class="panel">
    <div class="panel-header">
      <div class="dm-title">ðŸ§ª The Marketing Alchemist</div>
      <button id="btnQuest">Quest Node</button>
    </div>
    <div class="panel-body">
      <div class="dm-line" id="dmTitle"></div>
      <div class="dm-line" id="dmLore"></div>
      <div class="dm-line" id="dmVerdict"></div>
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <span class="pill" id="bankReadout">BANK: â€”</span>
        <span class="pill" id="levelCfg">CFG: â€”</span>
      </div>
    </div>
  </div>

  <!-- GAME PANEL -->
  <div class="panel">
    <div class="panel-header">
      <strong>Bottle Fill</strong>
      <div class="pill">Level <span id="lvl">1</span></div>
    </div>
    <div class="panel-body">
      <div class="board" id="board"></div>
      <div class="footer" style="margin-top:14px;">
        <button id="btnNext">Next Level</button>
        <button id="btnReset">Reset Run</button>
      </div>
    </div>
  </div>

</div>

<script>
/* =========================================================
   CONSTANTS & HELPERS
========================================================= */
const API = "http://localhost:8787/api/level-recipe";
const COLORS = ["#63b3ff","#ff6b6b","#ffd166","#b6ff6b","#c792ff","#7ef0d5","#ff9ff3","#feca57"];

const clamp01 = x => Math.max(0, Math.min(1, x));
const shuffle = a => { for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; };

/* =========================================================
   GAME STATE
========================================================= */
const game = {
  level: 1,
  sessionSeed: Math.random().toString(36).slice(2),
  moves: 0
};

let bottles = [];
let selected = null;

/* =========================================================
   BANK (simplified inference)
========================================================= */
const playerModel = { moves:0, invalid:0 };

function inferBANK() {
  if (playerModel.invalid / Math.max(1, playerModel.moves) > 0.2) return { bankPrimary:"N", bankConfidence:0.6 };
  if (playerModel.moves < 10) return { bankPrimary:"B", bankConfidence:0.4 };
  return { bankPrimary:"A", bankConfidence:0.6 };
}

/* =========================================================
   C3 â€” FETCH RECIPE
========================================================= */
async function fetchRecipe() {
  const bank = inferBANK();
  const body = {
    act: "ACT_I",
    questId: "Q1",
    thesis: "UR_without_CL",
    bankPrimary: bank.bankPrimary,
    bankConfidence: bank.bankConfidence,
    sinTags: [],
    performanceSummary: {},
    seed: `${game.sessionSeed}:L${game.level}`
  };

  const res = await fetch(API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const json = await res.json();
  if (!json.ok) throw new Error(json.error);
  return json.recipe;
}

/* =========================================================
   C3 â€” SOLVABLE COMPILER
========================================================= */
function compileRecipe(recipe) {
  const slots = 4;
  const chosen = recipe.elements.slice(0, recipe.colors);
  const colors = chosen.map((_,i)=>COLORS[i%COLORS.length]);

  const out = [];
  colors.forEach(c => out.push({ cells:[c,c,c,c], locked:false }));
  for (let i=0;i<recipe.emptyBottles;i++) out.push({ cells:[], locked:false });

  shuffle(out);
  return out;
}

/* =========================================================
   RENDER
========================================================= */
function render() {
  document.getElementById("lvl").textContent = game.level;
  document.getElementById("board").innerHTML = "";

  bottles.forEach((b,i)=>{
    const el = document.createElement("div");
    el.className = "bottle" + (selected===i?" selected":"") + (b.locked?" locked":"");
    for (let s=3;s>=0;s--){
      const slot = document.createElement("div");
      slot.className = "slot";
      if (b.cells[s]) {
        const f = document.createElement("div");
        f.className = "fill";
        f.style.background = b.cells[s];
        slot.appendChild(f);
      }
      el.appendChild(slot);
    }
    el.onclick = ()=>onBottle(i);
    document.getElementById("board").appendChild(el);
  });

  const bank = inferBANK();
  document.getElementById("bankReadout").textContent =
    `BANK: ${bank.bankPrimary} (${bank.bankConfidence.toFixed(2)})`;
}

/* =========================================================
   GAMEPLAY
========================================================= */
function onBottle(i){
  if (selected===null){ selected=i; render(); return; }
  if (selected===i){ selected=null; render(); return; }

  const from = bottles[selected];
  const to = bottles[i];
  selected = null;

  if (!from.cells.length || to.cells.length>=4) {
    playerModel.invalid++;
    render();
    return;
  }

  const c = from.cells[from.cells.length-1];
  if (to.cells.length && to.cells[to.cells.length-1]!==c) {
    playerModel.invalid++;
    render();
    return;
  }

  to.cells.push(from.cells.pop());
  playerModel.moves++;
  render();
}

/* =========================================================
   LEVEL FLOW
========================================================= */
async function startLevel() {
  const recipe = await fetchRecipe();
  bottles = compileRecipe(recipe);

  document.getElementById("dmTitle").textContent = recipe.title;
  document.getElementById("dmLore").textContent = recipe.lore;
  document.getElementById("levelCfg").textContent =
    `b${recipe.bottleCount} c${recipe.colors} e${recipe.emptyBottles}`;

  render();
}

/* =========================================================
   BUTTONS
========================================================= */
document.getElementById("btnNext").onclick = async ()=>{
  game.level++;
  await startLevel();
};
document.getElementById("btnReset").onclick = async ()=>{
  game.level=1;
  playerModel.moves=0;
  playerModel.invalid=0;
  await startLevel();
};
document.getElementById("btnQuest").onclick = ()=>startLevel();

/* =========================================================
   INIT
========================================================= */
startLevel();
</script>
</body>
</html>

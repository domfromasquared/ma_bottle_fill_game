<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>The Marketing Alchemist ‚Äî Bottle Fill (Mobile)</title>

  <style>
    :root{
      --bg:#060b14;
      --panel:#0c1524;
      --stroke:#1b2b46;
      --txt:#e8eef7;
      --muted:#a9b6c8;

      --pad: 14px;
      --r: 18px;

      /* scaled by JS from #app width */
      --cell: 70px;
      --bottleW: 58px;
      --bottleH: 155px;
      --neckH: 16px;

      --glass: rgba(255,255,255,.08);
      --glassEdge: rgba(255,255,255,.18);
      --shine: rgba(255,255,255,.10);

      --ease: cubic-bezier(.2,.9,.2,1);

      /* Mobile layout constants */
      --modH: 76px;
      --bankW: 58px;
      --dmW: min(38vw, 180px);
      --bubbleMinH: 120px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height:100%; margin:0; background:#000; color: var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { overscroll-behavior:none; touch-action: manipulation; }

    #phone{
      height: 100%;
      display:flex;
      justify-content:center;
      padding:
        calc(env(safe-area-inset-top) + 10px)
        calc(env(safe-area-inset-right) + 10px)
        calc(env(safe-area-inset-bottom) + 10px)
        calc(env(safe-area-inset-left) + 10px);
      background: radial-gradient(1000px 800px at 30% 10%, #0b1a33 0%, #050910 55%, #000 100%);
    }

    #app{
      width: min(440px, 100%);
      height: 100%;
      display:flex;
      flex-direction:column;
      gap: 12px;
      position:relative;
    }

    /* Top: Quest / DM header */
    header.top{
      background: linear-gradient(180deg, rgba(12,21,36,0.95), rgba(8,14,25,0.95));
      border:1px solid var(--stroke);
      border-radius: var(--r);
      padding: var(--pad);
      flex: 0 0 auto;
    }

    .titleRow{
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }
    .brand{
      font-weight: 900; letter-spacing: .2px;
      font-size: 20px; line-height: 1.1;
      display:flex; align-items:center; gap: 8px;
    }

    .rightControls{
      display:flex; align-items:center; gap: 10px;
    }

    .apiPill{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--stroke);
      background: rgba(10,18,32,0.9);
      color: var(--txt);
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 800;
      max-width: 240px;
    }
    .apiPill .lbl{ opacity:.8; font-weight: 800; }
    .apiPill input{
      width: 150px; max-width: 38vw;
      background: transparent; border:0; outline: none;
      color: var(--txt);
      font-weight: 800;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
    }

    button.pill{
      border:1px solid var(--stroke);
      background: rgba(10,18,32,0.9);
      color: var(--txt);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 900;
    }
    button.pill:active{ transform: translateY(1px); }

    .questCard{
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(27,43,70,.9);
      background: rgba(6,11,20,.7);
    }
    .questTitle{
      font-size: 18px;
      font-weight: 900;
      margin-bottom: 6px;
    }
    .questText{
      font-size: 15px;
      color: var(--muted);
      line-height: 1.35;
      min-height: 42px;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .chip{
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(10,18,32,0.9);
      color: var(--txt);
      white-space: nowrap;
    }

    /* Play stage (portrait-first). Everything below is about layout. */
    main.play{
      flex: 1;
      min-height: 0;
      background: rgba(12,21,36,0.7);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      padding: 12px;
      overflow:hidden;
      position: relative;
    }

    .hudRow{
      display:flex; gap: 8px; align-items:center; justify-content:space-between;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .hudLeft, .hudRight{ display:flex; gap: 8px; align-items:center; flex-wrap:wrap; }
    .hudTitle{ font-weight: 900; font-size: 18px; }
    .hudPill{
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(10,18,32,0.9);
      color: var(--txt);
      white-space: nowrap;
    }

    /* The "stage" is a stacked layout.
       - Bottom layer: bottle grid (plays here)
       - Next: modifiers bar (lower section)
       - Next: DM character (slides in from left during quest nodes)
       - Next: speech bubble (DM text)
       - Top: BANK identifier on left edge (expandable) */
    .stage{
      position:absolute;
      left: 12px;
      right: 12px;
      top: 62px; /* below HUD row */
      bottom: 12px;
      border-radius: 14px;
      overflow:hidden;
      background: rgba(6,11,20,.20);
      border: 1px solid rgba(27,43,70,.55);
    }

    /* BOTTLE GRID ‚Äî anchored lower, behind modifiers */
    .bottleGrid{
      position:absolute;
      left: 0;
      right: 0;
      bottom: calc(var(--modH) + 12px);
      top: 0;
      display:grid;
      grid-template-columns: repeat(5, var(--cell));
      justify-content:center;
      align-content:end;
      gap: 10px;
      padding: 12px;
    }

    /* Responsive: 4 columns when needed */
    @media (max-width: 380px){
      .bottleGrid{ grid-template-columns: repeat(4, var(--cell)); }
    }
    @media (max-width: 340px){
      .bottleGrid{ grid-template-columns: repeat(3, var(--cell)); }
    }

    /* Bottle visuals */
    .bottleSlot{
      width: var(--cell);
      height: calc(var(--bottleH) + 18px);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      position: relative;
    }

    .bottle{
      width: var(--bottleW);
      height: var(--bottleH);
      border-radius: 14px 14px 16px 16px;
      position: relative;
      border: 2px solid var(--glassEdge);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
      overflow:hidden;
      transform: translateZ(0);
    }

    .bottle::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, transparent 0%, var(--shine) 35%, transparent 70%);
      opacity:.5;
      pointer-events:none;
      transform: translateX(-20%);
    }

    .neck{
      position:absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(var(--bottleW) * .58);
      height: calc(var(--neckH) + 8px);
      border-radius: 10px;
      border: 2px solid var(--glassEdge);
      background: rgba(255,255,255,.03);
    }

    .liquidStack{
      position:absolute;
      inset: 0;
      display:flex;
      flex-direction:column-reverse;
    }

    .layer{
      width:100%;
      height: 0px;
      transition: height 260ms var(--ease);
    }

    .bottle.selected{
      outline: 3px solid rgba(110,190,255,.95);
      box-shadow: 0 0 0 6px rgba(110,190,255,.15), 0 12px 24px rgba(0,0,0,.5);
    }
    .bottle.invalid{
      animation: shake 240ms var(--ease);
      outline: 3px solid rgba(255,90,90,.95);
      box-shadow: 0 0 0 6px rgba(255,90,90,.15);
    }
    @keyframes shake{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-4px); }
      50%{ transform: translateX(4px); }
      75%{ transform: translateX(-3px); }
      100%{ transform: translateX(0); }
    }

    /* Pour animation */
    .pourStream{
      position:absolute;
      width: 10px;
      border-radius: 999px;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
      opacity: 0;
      transform-origin: top center;
      pointer-events:none;
      z-index: 2;
    }
    .pourStream.on{
      opacity: 1;
      animation: stream 520ms var(--ease) forwards;
    }
    @keyframes stream{
      0%{ transform: scaleY(.2); }
      25%{ transform: scaleY(1); }
      70%{ transform: scaleY(1); opacity: 1; }
      100%{ transform: scaleY(.25); opacity: 0; }
    }

    /* MODIFIERS bar (lower section, above bottle grid) */
    .modifiersBar{
      position:absolute;
      left: 12px;
      right: 12px;
      bottom: 12px;
      height: var(--modH);
      border-radius: 16px;
      border:1px solid rgba(27,43,70,.9);
      background: rgba(12,21,36,0.90);
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      overflow:hidden;
      color: rgba(255,255,255,.68);
      font-weight: 900;
      z-index: 5;
    }
    .modsLabel{ opacity:.7; font-weight:900; margin-right: 6px; }
    .modSlot{
      flex: 1;
      min-width: 0;
      height: 100%;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.15);
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(255,255,255,.45);
      font-weight: 900;
    }
    .modPlus{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border:1px solid rgba(27,43,70,.9);
      background: rgba(10,18,32,0.9);
      color: var(--txt);
      font-weight: 1000;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .modPlus:active{ transform: translateY(1px); }

    /* DM overlay (character + speech). Hidden unless .dmOn is set on .stage */
    .dmLayer{
      position:absolute;
      left: 0;
      right: 0;
      top: 10px;
      bottom: calc(var(--modH) + 18px);
      pointer-events:none;
      z-index: 8;
      display:flex;
      align-items:flex-end;
      justify-content:flex-start;
    }
    .stage.dmOn .dmLayer{ pointer-events:auto; }

    .dmCharacter{
      width: var(--dmW);
      max-width: 180px;
      aspect-ratio: 1 / 1.25;
      border-radius: 16px;
      border:1px solid rgba(27,43,70,.9);
      background: rgba(0,0,0,.30);
      overflow:hidden;
      position:absolute;
      left: -220px;
      bottom: 20px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      color: rgba(255,255,255,.55);
      font-weight: 900;
      letter-spacing:.4px;
      box-shadow: 0 18px 28px rgba(0,0,0,.45);
      transform: translateX(0);
    }
    .dmCharacter img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
      opacity:.95;
    }

    .dmClose{
      position:absolute;
      top: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border:1px solid rgba(27,43,70,.9);
      background: rgba(10,18,32,0.92);
      color: var(--txt);
      font-weight: 1000;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:auto;
    }
    .dmClose:active{ transform: translateY(1px); }

    .dmBubble{
      position:absolute;
      left: calc(var(--dmW) + 12px);
      right: 12px;
      bottom: 20px;
      min-height: var(--bubbleMinH);
      max-height: 55%;
      border-radius: 18px;
      border:1px solid rgba(27,43,70,.9);
      background: rgba(12,21,36,0.92);
      padding: 12px 12px 12px 14px;
      overflow:hidden;
      box-shadow: 0 18px 28px rgba(0,0,0,.40);
      pointer-events:auto;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .dmBubble .bubbleTitle{
      font-weight: 1000;
      letter-spacing:.2px;
      opacity:.92;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .dmBubble .bubbleText{
      color: var(--txt);
      opacity:.88;
      line-height: 1.35;
      font-size: 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .stage.dmOn .dmCharacter{
      animation: dmIn 520ms var(--ease) forwards, dmShake 220ms var(--ease) 520ms 1;
    }
    @keyframes dmIn{
      0%{ left: -220px; }
      100%{ left: 12px; }
    }
    @keyframes dmShake{
      0%{ transform: translateX(0); }
      40%{ transform: translateX(-3px); }
      70%{ transform: translateX(3px); }
      100%{ transform: translateX(0); }
    }

    /* BANK IDENTIFIER (left, expandable) */
    .bankDock{
      position:absolute;
      left: 8px;
      top: 10px;
      bottom: calc(var(--modH) + 18px);
      width: var(--bankW);
      z-index: 9;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      pointer-events:auto;
    }

    .bankPanel{
      width: var(--bankW);
      border-radius: 16px;
      border: 1px solid rgba(27,43,70,.9);
      background: rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      user-select:none;
    }

    .bankLetters{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:space-between;
      padding: 10px 6px;
      gap: 10px;
      flex: 0 0 auto;
    }
    .bankLetter{
      width: 100%;
      padding: 10px 0;
      border-radius: 12px;
      text-align:center;
      font-weight: 1000;
      letter-spacing: .9px;
      color: rgba(255,255,255,.35);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .bankLetter.on{ color: #fff; border-color: rgba(255,255,255,.22); }
    .bankLetter.b.on{ background: rgba(47,107,255,.22); }
    .bankLetter.a.on{ background: rgba(255,59,59,.20); }
    .bankLetter.n.on{ background: rgba(108,255,58,.18); }
    .bankLetter.k.on{ background: rgba(255,176,32,.18); }

    .bankHint{
      padding: 10px 8px 12px;
      font-size: 11px;
      color: rgba(255,255,255,.55);
      border-top: 1px solid rgba(255,255,255,.08);
      text-align:center;
    }

    .bankExpand{
      position:absolute;
      left: calc(var(--bankW) + 8px);
      top: 0;
      width: 0;
      max-width: 0;
      opacity: 0;
      transform: translateX(-6px);
      transition: all 220ms var(--ease);
      pointer-events:none;
      height: auto;
    }

    .bankDock.expanded .bankExpand{
      width: min(260px, 60vw);
      max-width: min(260px, 60vw);
      opacity: 1;
      transform: translateX(0);
      pointer-events:auto;
    }

    .bankExplain{
      border-radius: 16px;
      border: 1px solid rgba(27,43,70,.9);
      background: rgba(12,21,36,.92);
      padding: 10px 12px;
      box-shadow: 0 18px 28px rgba(0,0,0,.35);
    }
    .bankExplain h3{
      margin: 0 0 8px 0;
      font-size: 13px;
      letter-spacing: .2px;
    }
    .bankExplain p{
      margin: 0 0 8px 0;
      font-size: 12px;
      color: rgba(255,255,255,.78);
      line-height: 1.35;
    }
    .bankExplain p:last-child{ margin-bottom: 0; }

    /* When DM is up, pause taps on bottle grid */
    .stage.dmOn .bottleGrid{ pointer-events:none; filter: saturate(.92) brightness(.96); }
    .stage.dmOn .modifiersBar{ pointer-events:none; opacity: .55; }

    @media (max-height: 720px){
      :root{ --bubbleMinH: 110px; }
      .dmBubble{ max-height: 60%; }
    }
  </style>
</head>

<body>
  <div id="phone">
    <div id="app">

      <header class="top">
        <div class="titleRow">
          <div class="brand">üß™ The Marketing Alchemist <span style="opacity:.65; font-weight:900;">(Quest DM)</span></div>

          <div class="rightControls">
            <div class="apiPill" title="API base URL (Render)">
              <span class="lbl">API:</span>
              <input id="apiBase" value="https://ma-bottle-fill-api.onrender.com" />
            </div>
            <button class="pill" id="questBtn">Quest Node</button>
          </div>
        </div>

        <div class="questCard" id="questCard">
          <div class="questTitle" id="questTitle">Mobile Build</div>
          <div class="questText" id="questText">Tap bottles ‚Üí tap target. Portrait-only layout. DM appears every 3‚Äì6 levels (random).</div>
          <div class="chips">
            <span class="chip" id="statusChip">Status: ready</span>
            <span class="chip" id="bankChip">BANK: ‚Äî</span>
            <span class="chip" id="sinChip">SinTags: ‚Äî</span>
            <span class="chip" id="cfgChip">LevelCfg: ‚Äî</span>
          </div>
        </div>
      </header>

      <main class="play">
        <div class="hudRow">
          <div class="hudLeft">
            <div class="hudTitle">Bottle Fill</div>
            <div class="hudPill" id="lvlPill">Level: 1</div>
            <div class="hudPill" id="movesPill">Moves: 0</div>
            <div class="hudPill" id="badPill">Invalid: 0</div>
            <div class="hudPill" id="resetPill">Resets: 0</div>
          </div>
          <div class="hudRight">
            <button class="pill" id="nextBtn">Next Level</button>
            <button class="pill" id="resetBtn">Reset Run</button>
          </div>
        </div>

        <section class="stage" id="stage">
          <!-- BANK IDENTIFIER -->
          <aside class="bankDock" id="bankDock" aria-label="BANK Identifier">
            <div class="bankPanel" id="bankPanel" role="button" aria-label="Toggle BANK definitions">
              <div class="bankLetters" aria-hidden="true">
                <div class="bankLetter b" data-letter="B">B</div>
                <div class="bankLetter a" data-letter="A">A</div>
                <div class="bankLetter n" data-letter="N">N</div>
                <div class="bankLetter k" data-letter="K">K</div>
              </div>
              <div class="bankHint">Tap for meaning</div>
            </div>

            <div class="bankExpand" id="bankExpand">
              <div class="bankExplain">
                <h3>What ‚ÄúBANK‚Äù means (not finance)</h3>
                <p><b>B</b> = <b>Blueprint</b> (process, clarity, step-by-step)</p>
                <p><b>A</b> = <b>Action</b> (speed, bold moves, results)</p>
                <p><b>N</b> = <b>Nurturing</b> (trust, care, relationships)</p>
                <p><b>K</b> = <b>Knowledge</b> (facts, logic, proof)</p>
              </div>
            </div>
          </aside>

          <!-- BOTTLE GRID -->
          <div class="bottleGrid" id="bottleGrid" aria-label="Bottle Grid"></div>

          <!-- MODIFIERS -->
          <div class="modifiersBar" id="modifiersBar" aria-label="Modifiers">
            <span class="modsLabel">MODIFIERS</span>
            <div class="modSlot">Slot 1</div>
            <div class="modSlot">Slot 2</div>
            <div class="modSlot">Slot 3</div>
            <div class="modPlus" id="modsPlus" title="Shop (later)">+</div>
          </div>

          <!-- DM OVERLAY -->
          <div class="dmLayer" id="dmLayer" aria-label="DM Overlay">
            <div class="dmCharacter" id="dmCharacter" aria-label="DM Character">
              <img id="dmImg" alt="DM" src="assets/dm/furious/001.png" style="display:none;" />
              <div id="dmPlaceholder" style="padding: 10px 8px 12px; text-align:center; width:100%;">CHARACTER</div>
              <button class="dmClose" id="dmClose" aria-label="Close DM">√ó</button>
            </div>

            <div class="dmBubble" id="dmBubble" aria-label="Speech Bubble">
              <div class="bubbleTitle">
                <span>DM SPEECH</span>
                <span style="opacity:.6; font-size:12px;">(tap √ó to resume)</span>
              </div>
              <div class="bubbleText" id="speechBubble">SPEECH BUBBLE</div>
            </div>
          </div>
        </section>
      </main>

    </div>
  </div>

  <script>
    function applyMobileScale(){
      const app = document.getElementById("app");
      const w = app.clientWidth;
      const cell = Math.max(54, Math.min(84, Math.floor(w * 0.17)));
      const bottleW = Math.floor(cell * 0.86);
      const bottleH = Math.floor(cell * 2.25);
      document.documentElement.style.setProperty("--cell", cell + "px");
      document.documentElement.style.setProperty("--bottleW", bottleW + "px");
      document.documentElement.style.setProperty("--bottleH", bottleH + "px");
    }
    window.addEventListener("resize", applyMobileScale, { passive:true });
    window.addEventListener("orientationchange", applyMobileScale, { passive:true });
    applyMobileScale();

    const PALETTE = [
      { id:"AQUA",   hex:"#18c8ff" },
      { id:"LIME",   hex:"#6cff3a" },
      { id:"VIOLET", hex:"#a855ff" },
      { id:"AMBER",  hex:"#ffb020" },
      { id:"ROSE",   hex:"#ff3ea5" },
      { id:"RED",    hex:"#ff3b3b" },
      { id:"BLUE",   hex:"#2f6bff" },
      { id:"TEAL",   hex:"#12f0c0" },
      { id:"SAND",   hex:"#d6b58c" },
      { id:"SLATE",  hex:"#7b8aa8" }
    ];
    const COLOR = Object.fromEntries(PALETTE.map(x => [x.id, x.hex]));
    const CAP = 4;

    let level = 1, moves = 0, invalid = 0, resets = 0;
    let bottles = [], initialBottles = [], selected = -1;

    let nextDMAt = rollDM(level);
    let dmVisits = 0;
    const MOD_EVERY = 5;

    const telemetry = {
      startedAt: Date.now(),
      taps: 0,
      pours: 0,
      invalid: 0,
      resets: 0,
      lastTapAt: 0,
      avgDecisionMs: 0,
      _decisions: [],
      streakBad: 0
    };

    const elGrid = document.getElementById("bottleGrid");
    const lvlPill = document.getElementById("lvlPill");
    const movesPill = document.getElementById("movesPill");
    const badPill = document.getElementById("badPill");
    const resetPill = document.getElementById("resetPill");

    const questBtn = document.getElementById("questBtn");
    const nextBtn = document.getElementById("nextBtn");
    const resetBtn = document.getElementById("resetBtn");

    const apiBaseInput = document.getElementById("apiBase");
    const questTitle = document.getElementById("questTitle");
    const questText = document.getElementById("questText");
    const statusChip = document.getElementById("statusChip");
    const bankChip = document.getElementById("bankChip");
    const sinChip = document.getElementById("sinChip");
    const cfgChip = document.getElementById("cfgChip");

    const stage = document.getElementById("stage");
    const speechBubble = document.getElementById("speechBubble");
    const modifiersBar = document.getElementById("modifiersBar");
    const modsPlus = document.getElementById("modsPlus");

    const dmClose = document.getElementById("dmClose");
    const bankDock = document.getElementById("bankDock");
    const bankPanel = document.getElementById("bankPanel");

    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function deepCopy(x){ return JSON.parse(JSON.stringify(x)); }

    function rollDM(currentLevel){
      const span = 3 + Math.floor(Math.random()*4);
      return currentLevel + span;
    }

    function setStatus(text, ok=true){
      statusChip.textContent = "Status: " + text;
      statusChip.style.borderColor = ok ? "rgba(27,43,70,.9)" : "rgba(255,90,90,.95)";
    }

    function apiBase(){
      let v = (apiBaseInput.value || "").trim();
      if (!v) return "";
      if (v.endsWith("/")) v = v.slice(0,-1);
      return v;
    }

    async function postJSON(path, body){
      const base = apiBase();
      if (!base) throw new Error("Missing API base");
      const url = base + path;
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const txt = await res.text();
      let json = null;
      try{ json = JSON.parse(txt); }catch(_){}
      if (!res.ok){
        const errMsg = (json && json.error) ? json.error : (txt || ("HTTP " + res.status));
        const e = new Error(errMsg);
        e.status = res.status;
        e.details = json && json.details;
        throw e;
      }
      return json;
    }

    function localLevelRecipe(level){
      const rng = mulberry32(0xC0FFEE ^ (level * 2654435761));
      const colorsCount = clamp(3 + Math.floor(level/3), 3, 8);
      const bottleCount = clamp(6 + Math.floor(level/2), 6, 15);
      const empties = 2;

      const colors = PALETTE.slice(0, colorsCount).map(c => c.id);
      let pool = [];
      for (const c of colors){ for (let i=0;i<CAP;i++) pool.push(c); }
      while (pool.length < (bottleCount-empties)*CAP){
        const c = colors[Math.floor(rng()*colors.length)];
        pool.push(c);
      }
      for (let i=pool.length-1;i>0;i--){
        const j = Math.floor(rng()*(i+1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }

      const b = [];
      for (let i=0;i<bottleCount-empties;i++) b.push(pool.slice(i*CAP, (i+1)*CAP));
      for (let i=0;i<empties;i++) b.push([]);
      return { bottleCount, capacity: CAP, colors, bottles: b, levelCfg: `b${bottleCount}/c${colorsCount}/cap${CAP}/local` };
    }

    function mulberry32(a){
      return function(){
        a |= 0; a = a + 0x6D2B79F5 | 0;
        let t = Math.imul(a ^ a >>> 15, 1 | a);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }

    async function buildLevel(level){
      setStatus("loading level‚Ä¶");
      try{
        const payload = { level, mode:"mobile", capacity: CAP, telemetry: packTelemetry() };
        const data = await postJSON("/api/level-recipe", payload);
        const recipe = data.recipe || data.level || data;
        applyRecipe(recipe);
        cfgChip.textContent = "LevelCfg: " + (recipe.levelCfg || "server");
        setStatus("level ready");
        return;
      }catch(e){
        const recipe = localLevelRecipe(level);
        applyRecipe(recipe);
        cfgChip.textContent = "LevelCfg: " + recipe.levelCfg;
        setStatus("level ready (fallback)", false);
      }
    }

    function applyRecipe(recipe){
      bottles = deepCopy(recipe.bottles || []);
      initialBottles = deepCopy(bottles);
      selected = -1;
      moves = 0;
      invalid = 0;
      updateHUD();
      render();
    }

    function topColor(b){ return b.length ? b[b.length - 1] : null; }
    function topRunCount(b){
      if (!b.length) return 0;
      const c = topColor(b);
      let n=0;
      for (let i=b.length-1;i>=0;i--){ if (b[i] !== c) break; n++; }
      return n;
    }

    function canPour(fromIdx, toIdx){
      if (fromIdx === toIdx) return false;
      const from = bottles[fromIdx], to = bottles[toIdx];
      if (!from.length) return false;
      if (to.length >= CAP) return false;
      const fc = topColor(from), tc = topColor(to);
      if (!tc) return true;
      return tc === fc;
    }

    function pourAmount(fromIdx, toIdx){
      return Math.min(topRunCount(bottles[fromIdx]), CAP - bottles[toIdx].length);
    }

    function doPour(fromIdx, toIdx){
      if (!canPour(fromIdx, toIdx)) return false;
      const amt = pourAmount(fromIdx, toIdx);
      if (amt <= 0) return false;
      const c = topColor(bottles[fromIdx]);
      for (let i=0;i<amt;i++){ bottles[fromIdx].pop(); bottles[toIdx].push(c); }
      return { amt, color: c };
    }

    function isSolved(){
      for (const b of bottles){
        if (!b.length) continue;
        if (b.length !== CAP) return false;
        const c = b[0];
        for (let i=1;i<b.length;i++){ if (b[i] !== c) return false; }
      }
      return true;
    }

    function updateHUD(){
      lvlPill.textContent = "Level: " + level;
      movesPill.textContent = "Moves: " + moves;
      badPill.textContent = "Invalid: " + invalid;
      resetPill.textContent = "Resets: " + resets;
    }

    function render(){
      elGrid.innerHTML = "";
      bottles.forEach((b, idx) => {
        const slot = document.createElement("div");
        slot.className = "bottleSlot";

        const bottle = document.createElement("div");
        bottle.className = "bottle";
        bottle.dataset.idx = String(idx);
        if (idx === selected) bottle.classList.add("selected");

        const neck = document.createElement("div"); neck.className = "neck";
        const stack = document.createElement("div"); stack.className = "liquidStack";

        const segH = (parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--bottleH")) / CAP);
        for (let i=0;i<CAP;i++){
          const layer = document.createElement("div");
          layer.className = "layer";
          const c = b[i] || null;
          if (c){ layer.style.background = COLOR[c] || c; layer.style.height = segH + "px"; }
          else { layer.style.height = "0px"; }
          stack.appendChild(layer);
        }

        bottle.appendChild(stack);
        bottle.appendChild(neck);
        slot.appendChild(bottle);
        elGrid.appendChild(slot);

        bottle.addEventListener("click", () => onBottleTap(idx));
      });
    }

    function markInvalid(idx){
      const node = elGrid.querySelector(`.bottle[data-idx="${idx}"]`);
      if (!node) return;
      node.classList.remove("invalid");
      void node.offsetWidth;
      node.classList.add("invalid");
      setTimeout(() => node.classList.remove("invalid"), 260);
    }

    function streamPour(fromIdx, toIdx, colorHex){
      const fromEl = elGrid.querySelector(`.bottle[data-idx="${fromIdx}"]`);
      const toEl = elGrid.querySelector(`.bottle[data-idx="${toIdx}"]`);
      if (!fromEl || !toEl) return;

      const gridRect = elGrid.getBoundingClientRect();
      const a = fromEl.getBoundingClientRect();
      const b = toEl.getBoundingClientRect();
      const x1 = (a.left + a.right)/2 - gridRect.left;
      const y1 = a.top - gridRect.top + 8;
      const x2 = (b.left + b.right)/2 - gridRect.left;
      const y2 = b.top - gridRect.top + 10;
      const dx = x2 - x1;
      const dy = Math.max(40, y2 - y1);

      const stream = document.createElement("div");
      stream.className = "pourStream";
      stream.style.left = (x1 - 5) + "px";
      stream.style.top = (y1) + "px";
      stream.style.height = dy + "px";
      stream.style.background = colorHex;
      stream.style.transform = `rotate(${Math.atan2(dy, dx) * 180/Math.PI}deg)`;
      elGrid.appendChild(stream);
      requestAnimationFrame(() => stream.classList.add("on"));
      setTimeout(() => stream.remove(), 620);
    }

    function onBottleTap(idx){
      if (stage.classList.contains("dmOn")) return;

      const now = Date.now();
      telemetry.taps++;
      if (telemetry.lastTapAt){
        const dt = now - telemetry.lastTapAt;
        telemetry._decisions.push(dt);
        telemetry.avgDecisionMs = Math.round(telemetry._decisions.reduce((a,b)=>a+b,0)/telemetry._decisions.length);
      }
      telemetry.lastTapAt = now;

      if (selected === -1){
        if (!bottles[idx].length){
          markInvalid(idx);
          invalid++; telemetry.invalid++;
          updateHUD();
          return;
        }
        selected = idx;
        render();
        return;
      }

      const from = selected, to = idx;
      if (from === to){ selected = -1; render(); return; }

      if (!canPour(from, to)){
        invalid++; telemetry.invalid++; telemetry.streakBad++;
        markInvalid(to);
        updateHUD();
        return;
      }

      const beforeColor = topColor(bottles[from]);
      doPour(from, to);
      moves++; telemetry.pours++; telemetry.streakBad = 0;
      updateHUD();
      streamPour(from, to, COLOR[beforeColor] || beforeColor);

      setTimeout(() => {
        render();
        if (isSolved()){
          speechBubble.textContent = "Solved. Yes, yes. You can stop panic-pouring now.";
        }
      }, 160);

      if (!bottles[from].length) selected = -1;
    }

    function shouldShowDM(){ return level >= nextDMAt; }
    function shouldRequestModifier(){ return (dmVisits > 0) && (dmVisits % MOD_EVERY === 0); }

    function packTelemetry(){
      return {
        sessionMs: Date.now() - telemetry.startedAt,
        taps: telemetry.taps,
        pours: telemetry.pours,
        invalid: telemetry.invalid,
        resets: telemetry.resets,
        avgDecisionMs: telemetry.avgDecisionMs,
        streakBad: telemetry.streakBad,
        level, moves,
      };
    }

    function setDMVisible(on){
      stage.classList.toggle("dmOn", !!on);
      if (!on){ selected = -1; render(); }
    }

    function setBANKLetter(letter){
      const letters = bankPanel.querySelectorAll(".bankLetter");
      letters.forEach(el => el.classList.remove("on"));
      const t = bankPanel.querySelector(`.bankLetter[data-letter="${letter}"]`);
      if (t) t.classList.add("on");
    }

    async function fetchQuestNode({force=false} = {}){
      const dmNow = force || shouldShowDM();
      if (!dmNow){
        questTitle.textContent = "No DM right now";
        questText.textContent = "Keep brewing. DM appears every 3‚Äì6 levels (random).";
        return;
      }

      dmVisits++;
      if (!force) nextDMAt = rollDM(level);
      const wantModifier = shouldRequestModifier();

      setStatus("brewing quest‚Ä¶");
      questTitle.textContent = wantModifier ? "Major Ritual (Modifiers)" : "Minor Check-in";
      questText.textContent = "Summoning the DM‚Ä¶";
      setDMVisible(true);

      try{
        const payload = {
          level,
          cadence: { dmEveryMin: 3, dmEveryMax: 6, modifierEveryDM: MOD_EVERY },
          wantModifier,
          telemetry: packTelemetry(),
          bankDefinition: "BANK is a marketing personality system (Blueprint/Action/Nurturing/Knowledge). Not related to finance or banking."
        };
        const data = await postJSON("/api/quest-node", payload);
        const node = data.node || data.quest || data;

        questTitle.textContent = node.quest_title || node.title || (wantModifier ? "Major Ritual" : "Minor DM Check-in");
        questText.textContent = node.quest_text || node.text || "‚Ä¶";

        const b = node.bank || node.bank_letter || "‚Äî";
        const conf = (node.bank_confidence != null) ? node.bank_confidence : node.bank_score;
        bankChip.textContent = `BANK: ${b}${(conf!=null) ? ` (${Number(conf).toFixed(2)})` : ""}`;

        const sins = node.sinTags || node.sin_tags || [];
        sinChip.textContent = "SinTags: " + (Array.isArray(sins) ? sins.join(", ") : (sins || "‚Äî"));

        if (node.levelCfg) cfgChip.textContent = "LevelCfg: " + node.levelCfg;
        speechBubble.textContent = node.dm_line || node.quest_dm_line || node.voice_line || node.quest_text || "‚Ä¶";

        if (typeof b === "string" && b.length){
          setBANKLetter(b.trim().toUpperCase().slice(0,1));
        }

        setStatus("quest ready");
      }catch(e){
        setStatus("quest error", false);
        questTitle.textContent = "Fallback Brew (Server Offline)";
        questText.textContent = "The lab lights flicker. Your API gremlins demand tribute. Brew anyway.";
        speechBubble.textContent = "Tap bottles ‚Üí tap target. Stop overthinking, apprentice.";
        setBANKLetter("‚Äî");
      }
    }

    questBtn.addEventListener("click", () => fetchQuestNode({force:true}));

    nextBtn.addEventListener("click", async () => {
      level++;
      selected = -1;

      if (shouldShowDM()){
        await fetchQuestNode({force:false});
      } else {
        questTitle.textContent = "Brew in progress";
        questText.textContent = "No DM. Deterministic level between rituals.";
      }
      await buildLevel(level);
    });

    resetBtn.addEventListener("click", async () => {
      resets++; telemetry.resets++;
      selected = -1;
      bottles = deepCopy(initialBottles);
      moves = 0; invalid = 0;
      updateHUD();
      render();
      setStatus("reset");
      speechBubble.textContent = "Reset again? Beautiful. Indecision in its natural habitat.";
    });

    dmClose.addEventListener("click", () => setDMVisible(false));
    bankPanel.addEventListener("click", () => bankDock.classList.toggle("expanded"));

    modsPlus.addEventListener("click", () => {
      speechBubble.textContent = "Shop coming soon. Stop trying to buy your way out of fundamentals.";
      setDMVisible(true);
    });

    (async function init(){
      questTitle.textContent = "Mobile Layout Locked";
      questText.textContent = "Portrait-first. 5√ó3-capable grid. Modifiers docked bottom. DM overlays pause the game.";
      setDMVisible(false);
      await buildLevel(level);
    })();
  </script>
</body>
</html>

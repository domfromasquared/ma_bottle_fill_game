<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Marketing Alchemist — Bottle Fill (Mobile)</title>

  <style>
    :root{
      --bg0:#060a12;
      --bg1:#0b1220;
      --panel:#0d1728;
      --stroke:#22324a;
      --stroke2:#2a3b57;
      --text:#e8f0ff;
      --muted:#a7b4cc;

      --bankB:#3aa0ff; /* Blue */
      --bankA:#ff3b3b; /* Red */
      --bankN:#3dff6a; /* Green */
      --bankK:#ffd43b; /* Yellow */

      --radius:18px;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; margin:0; background: radial-gradient(1200px 900px at 50% -10%, #132246, #070b14 60%, #05070c); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    button{ font:inherit; color:inherit; }

    /* --- Mobile frame --- */
    .app{
      height:100%;
      display:flex;
      justify-content:center;
      align-items:stretch;
      padding: calc(10px + var(--safeTop)) 10px calc(10px + var(--safeBottom));
    }

    .phone{
      width: min(430px, 100%);
      height: 100%;
      max-height: 900px;
      display:flex;
      flex-direction:column;
      gap:10px;
      position:relative;
    }

    /* --- Header (optional placeholder bar) --- */
    .topbar{
      background: linear-gradient(180deg, rgba(14,25,45,.9), rgba(10,18,32,.75));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height:56px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.2px;
    }
    .brand .dot{ width:10px; height:10px; border-radius:999px; background:#66ffcc; box-shadow:0 0 18px rgba(102,255,204,.65); }
    .brand small{ color:var(--muted); font-weight:600; }
    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background: rgba(6,10,18,.55);
      color:var(--muted);
      font-weight:700;
    }

    /* --- Main stage (this is where layers live) --- */
    .stage{
      flex:1;
      position:relative;
      border-radius: var(--radius);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(12,20,36,.8), rgba(6,10,18,.85));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Split the stage into: upper overlay space + lower gameplay space */
    .stageInner{
      height:100%;
      display:grid;
      grid-template-rows: 1fr auto; /* top area grows, bottom gameplay fixed-ish */
    }

    /* --- Lower gameplay space: Modifiers + Bottle Grid --- */
    .gameLower{
      position:relative;
      padding: 10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      background: linear-gradient(180deg, rgba(6,10,18,0), rgba(6,10,18,.55));
    }

    /* Modifiers row */
    .modRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modPanel{
      flex:1;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(10,18,32,.55);
      padding:10px;
      display:flex;
      gap:10px;
      align-items:stretch;
    }
    .modSlot{
      flex:1;
      border:1px dashed rgba(167,180,204,.35);
      border-radius: 14px;
      background: rgba(6,10,18,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height:52px;
      position:relative;
      overflow:hidden;
    }
    .modSlot span{
      color:rgba(232,240,255,.65);
      font-weight:800;
      letter-spacing:.4px;
      font-size:13px;
      text-transform:uppercase;
    }
    .modPlus{
      width:34px; height:34px;
      border-radius:999px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      font-size:20px;
      line-height:1;
      color:rgba(232,240,255,.85);
    }
    .modLabel{
      font-weight:800;
      color:rgba(232,240,255,.85);
      font-size:12px;
      letter-spacing:.4px;
      text-transform:uppercase;
      opacity:.8;
      align-self:flex-start;
      padding:6px 8px;
      border:1px solid rgba(34,50,74,.65);
      border-radius:999px;
      background: rgba(6,10,18,.45);
    }

    /* Bottle grid panel */
    .bottlePanel{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(10,18,32,.55);
      padding:10px;
    }
    .bottleTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .bottleTitle h2{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }
    .bottleTitle .hint{
      color:var(--muted);
      font-weight:700;
      font-size:12px;
    }

    /* 5x3 beakers maximum — responsive sizing */
    .grid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:8px;
      /* Aim for comfortable thumb size and allow shrink */
      --cellMin: 52px;
    }
    .cell{
      aspect-ratio: 2 / 3; /* tall beaker silhouette area */
      border-radius: 18px;
      border:1px solid rgba(167,180,204,.25);
      background: rgba(6,10,18,.45);
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding:8px 6px;
    }
    .cell::before{
      content:"";
      position:absolute;
      inset:10% 16% 12% 16%;
      border-radius: 14px 14px 18px 18px;
      border:2px solid rgba(232,240,255,.18);
      background: rgba(255,255,255,.02);
    }
    .cellLabel{
      position:relative;
      z-index:2;
      font-size:11px;
      color:rgba(232,240,255,.55);
      font-weight:800;
      letter-spacing:.2px;
      text-transform:uppercase;
      user-select:none;
    }

    /* If the screen is narrow, move to 4 columns (still supports 5×3 logically; visually it wraps) */
    @media (max-width: 360px){
      .grid{ grid-template-columns: repeat(4, 1fr); }
    }

    /* --- BANK IDENTIFIER (left rail, always visible) --- */
    .bankRail{
      position:absolute;
      left:8px;
      top:8px;
      bottom:8px;
      width:64px;
      border-radius: 20px;
      border:1px solid var(--stroke);
      background: rgba(6,10,18,.55);
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:10px 8px;
      gap:10px;
      z-index:30;
      transition: width .22s ease, transform .22s ease;
      overflow:hidden;
      touch-action: manipulation;
    }
    .bankRail.expanded{
      width: 210px;
      align-items:stretch;
    }
    .bankLetters{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      flex: 0 0 auto;
    }
    .bankLetter{
      width:42px;
      height:42px;
      border-radius: 14px;
      border:1px solid rgba(167,180,204,.28);
      background: rgba(255,255,255,.03);
      display:grid;
      place-items:center;
      font-weight:1000;
      font-size:20px;
      color: rgba(232,240,255,.35);
      user-select:none;
    }
    .bankLetter.active.B{ color: var(--bankB); text-shadow: 0 0 18px rgba(58,160,255,.35); }
    .bankLetter.active.A{ color: var(--bankA); text-shadow: 0 0 18px rgba(255,59,59,.35); }
    .bankLetter.active.N{ color: var(--bankN); text-shadow: 0 0 18px rgba(61,255,106,.35); }
    .bankLetter.active.K{ color: var(--bankK); text-shadow: 0 0 18px rgba(255,212,59,.35); }

    .bankInfo{
      flex:1 1 auto;
      opacity:0;
      transform: translateX(-10px);
      transition: opacity .18s ease, transform .18s ease;
      padding:10px 10px 10px 6px;
      color:rgba(232,240,255,.78);
      font-weight:700;
      font-size:12px;
      line-height:1.35;
    }
    .bankRail.expanded .bankInfo{
      opacity:1;
      transform: translateX(0);
    }
    .bankInfo .row{
      display:flex; gap:8px; align-items:flex-start;
      padding:6px 8px;
      border-radius: 12px;
      border:1px solid rgba(34,50,74,.55);
      background: rgba(10,18,32,.4);
      margin-bottom:8px;
    }
    .bankInfo b{ display:inline-block; width:16px; }
    .bankInfo .b{ color: var(--bankB); }
    .bankInfo .a{ color: var(--bankA); }
    .bankInfo .n{ color: var(--bankN); }
    .bankInfo .k{ color: var(--bankK); }
    .bankHint{
      margin-top:8px;
      color:rgba(167,180,204,.85);
      font-weight:700;
      font-size:11px;
    }

    /* --- DM overlay (quest node moments pause gameplay) --- */
    .dmOverlay{
      position:absolute;
      inset:0;
      display:none; /* shown when active */
      z-index:40;
      background: radial-gradient(900px 700px at 65% 20%, rgba(30,80,160,.18), rgba(0,0,0,.55));
      backdrop-filter: blur(3px);
    }
    .dmOverlay.active{ display:block; }

    /* Speech bubble wrapper */
    .speechWrap{
      position:absolute;
      left:84px; /* leaves room for BANK rail */
      right:10px;
      top:10px;
      border-radius: var(--radius);
      border:1px solid var(--stroke);
      background: rgba(10,18,32,.72);
      box-shadow: 0 18px 44px rgba(0,0,0,.45);
      padding:12px 12px 12px 12px;
      overflow:hidden;
    }
    .speechHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .speechHeader .title{
      font-weight:1000;
      letter-spacing:.2px;
      font-size:14px;
      color:rgba(232,240,255,.92);
    }
    .speechHeader .sub{
      color:rgba(167,180,204,.92);
      font-weight:800;
      font-size:12px;
    }

    /* Speech bubble area auto-shrinks */
    .speechText{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(34,50,74,.55);
      background: rgba(6,10,18,.45);
      padding:12px;
      line-height:1.25;
      font-weight:800;
      overflow:hidden;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      min-height: 90px;
      max-height: 210px;
    }
    .speechText p{
      margin:0;
      width:100%;
      font-size: 18px; /* will auto-shrink via JS */
      letter-spacing:.1px;
      color:rgba(232,240,255,.95);
      word-break: break-word;
    }

    /* --- DM character slide-in from left --- */
    .dmChar{
      position:absolute;
      left:-260px; /* start hidden offscreen */
      bottom: 18%;
      width: min(240px, 52vw);
      height: auto;
      z-index:45;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,.55));
      transform: translateX(0);
      transition: transform .28s ease-out;
      will-change: transform;
      pointer-events:none; /* bubble handles input; close btn is separate */
    }
    .dmOverlay.active .dmChar{
      transform: translateX(280px); /* slides in */
    }

    /* Shake effect when arrived */
    .shake{
      animation: shake .28s ease-in-out 1;
    }
    @keyframes shake{
      0%{ transform: translateX(280px) rotate(0deg); }
      30%{ transform: translateX(280px) rotate(-2deg); }
      60%{ transform: translateX(280px) rotate(2deg); }
      100%{ transform: translateX(280px) rotate(0deg); }
    }

    /* Close (X) above character */
    .dmClose{
      position:absolute;
      left: 84px;
      top: 10px;
      z-index: 60;
      width:44px; height:44px;
      border-radius: 14px;
      border:1px solid rgba(34,50,74,.8);
      background: rgba(6,10,18,.6);
      display:none;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size:18px;
    }
    .dmOverlay.active .dmClose{ display:flex; }

    /* --- Shop modal placeholder (for modifiers +) --- */
    .modal{
      position:absolute;
      inset:0;
      z-index:80;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(4px);
    }
    .modal.active{ display:flex; }
    .modalCard{
      width:min(420px, 100%);
      border-radius: 22px;
      border:1px solid var(--stroke);
      background: rgba(10,18,32,.9);
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      padding:14px;
    }
    .modalTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .modalTop b{ font-size:15px; letter-spacing:.2px; }
    .modalTop button{
      width:40px; height:40px;
      border-radius: 14px;
      border:1px solid rgba(34,50,74,.8);
      background: rgba(6,10,18,.55);
      font-weight:1000;
      font-size:16px;
    }
    .modalBody{
      border-radius: 16px;
      border:1px dashed rgba(167,180,204,.25);
      background: rgba(6,10,18,.35);
      padding:12px;
      color:rgba(232,240,255,.78);
      font-weight:800;
      line-height:1.3;
      min-height: 160px;
    }

    /* --- Utility --- */
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="app">
    <div class="phone">
      <div class="topbar">
        <div class="brand">
          <div class="dot"></div>
          <div>
            <div>The Marketing Alchemist</div>
            <small>Mobile layout — placeholder zones</small>
          </div>
        </div>
        <div class="pill">Portrait • Tap UI</div>
      </div>

      <main class="stage" id="stage">
        <!-- BANK IDENTIFIER (left rail) -->
        <aside class="bankRail" id="bankRail" aria-label="BANK Identifier">
          <div class="bankLetters" aria-hidden="true">
            <div class="bankLetter B" data-letter="B">B</div>
            <div class="bankLetter A" data-letter="A">A</div>
            <div class="bankLetter N" data-letter="N">N</div>
            <div class="bankLetter K" data-letter="K">K</div>
          </div>

          <div class="bankInfo" id="bankInfo">
            <div class="row"><b class="b">B</b><div><span class="b">Blueprint</span> — step-by-step, clarity, structure.</div></div>
            <div class="row"><b class="a">A</b><div><span class="a">Action</span> — fast decisions, results, momentum.</div></div>
            <div class="row"><b class="n">N</b><div><span class="n">Nurturing</span> — people-first, trust, care, safety.</div></div>
            <div class="row"><b class="k">K</b><div><span class="k">Knowledge</span> — logic, data, proof, mastery.</div></div>
            <div class="bankHint">Tap again to collapse.</div>
          </div>
        </aside>

        <!-- DM quest overlay (CHARACTER + SPEECH) -->
        <div class="dmOverlay" id="dmOverlay" aria-hidden="true">
          <button class="dmClose" id="dmClose" aria-label="Close DM">✕</button>

          <!-- SPEECH BUBBLE -->
          <section class="speechWrap" role="dialog" aria-modal="true" aria-label="Quest Node">
            <div class="speechHeader">
              <div>
                <div class="title">SPEECH BUBBLE</div>
                <div class="sub">Quest node moment — game paused</div>
              </div>
              <div class="pill" style="padding:8px 10px;">DM • Quest</div>
            </div>

            <div class="speechText" id="speechText">
              <p id="speechP">
                Placeholder quest text. This area should shrink-to-fit longer text without overflowing.
              </p>
            </div>
          </section>

          <!-- CHARACTER (PNG) -->
          <!-- Replace src with your actual DM PNG path later -->
          <img
            class="dmChar"
            id="dmChar"
            src="assets/DM/furious/001.png"
            alt="Marketing Alchemist DM (Character)"
          />
        </div>

        <!-- Shop modal placeholder -->
        <div class="modal" id="shopModal" aria-hidden="true">
          <div class="modalCard">
            <div class="modalTop">
              <b>Modifier Shop (placeholder)</b>
              <button id="shopClose" aria-label="Close Shop">✕</button>
            </div>
            <div class="modalBody">
              This will be the modifier shop screen later.
              <br><br>
              For now: this confirms your “tap (+) → pop-up panel” layout works on mobile.
            </div>
          </div>
        </div>

        <!-- Main content (layers below overlays) -->
        <div class="stageInner">
          <div></div><!-- top spacer (so overlays feel like separate layer) -->

          <section class="gameLower" aria-label="Gameplay Lower Layer">
            <!-- MODIFIERS (layer above bottle grid) -->
            <div class="modRow">
              <div class="modLabel">MODIFIERS</div>
              <div class="pill" style="padding:8px 10px;">3 slots • tap (+) later</div>
            </div>

            <div class="modPanel" aria-label="Modifier Slots">
              <button class="modSlot" data-modslot="1" type="button" aria-label="Modifier slot 1">
                <div class="modPlus">+</div><span>Slot 1</span>
              </button>
              <button class="modSlot" data-modslot="2" type="button" aria-label="Modifier slot 2">
                <div class="modPlus">+</div><span>Slot 2</span>
              </button>
              <button class="modSlot" data-modslot="3" type="button" aria-label="Modifier slot 3">
                <div class="modPlus">+</div><span>Slot 3</span>
              </button>
            </div>

            <!-- BOTTLES GRID (bottom layer / main game) -->
            <div class="bottlePanel" aria-label="Bottle Grid Area">
              <div class="bottleTitle">
                <h2>BOTTLES GRID</h2>
                <div class="hint">Designed for up to 5×3 beakers</div>
              </div>

              <div class="grid" id="beakerGrid" aria-label="Beaker Grid">
                <!-- 15 cells placeholder (5×3) -->
                <div class="cell"><div class="cellLabel">1</div></div>
                <div class="cell"><div class="cellLabel">2</div></div>
                <div class="cell"><div class="cellLabel">3</div></div>
                <div class="cell"><div class="cellLabel">4</div></div>
                <div class="cell"><div class="cellLabel">5</div></div>

                <div class="cell"><div class="cellLabel">6</div></div>
                <div class="cell"><div class="cellLabel">7</div></div>
                <div class="cell"><div class="cellLabel">8</div></div>
                <div class="cell"><div class="cellLabel">9</div></div>
                <div class="cell"><div class="cellLabel">10</div></div>

                <div class="cell"><div class="cellLabel">11</div></div>
                <div class="cell"><div class="cellLabel">12</div></div>
                <div class="cell"><div class="cellLabel">13</div></div>
                <div class="cell"><div class="cellLabel">14</div></div>
                <div class="cell"><div class="cellLabel">15</div></div>
              </div>
            </div>

            <!-- Debug controls (temporary, remove later) -->
            <div style="display:flex; gap:10px; justify-content:space-between; margin-top:2px;">
              <button id="demoQuest" class="pill" style="border-radius:14px; justify-content:center; width:49%;">Demo Quest Node</button>
              <button id="demoBank" class="pill" style="border-radius:14px; justify-content:center; width:49%;">Cycle BANK</button>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <script>
    // ---------- BANK rail expand/collapse ----------
    const bankRail = document.getElementById("bankRail");
    bankRail.addEventListener("click", (e) => {
      // Allow click anywhere on rail
      bankRail.classList.toggle("expanded");
    });

    // ---------- BANK highlighting (demo placeholder) ----------
    const bankLetters = Array.from(document.querySelectorAll(".bankLetter"));
    const bankOrder = ["B","A","N","K"];
    let bankIdx = -1;

    function setActiveBank(letter){
      bankLetters.forEach(el => el.classList.remove("active"));
      const target = bankLetters.find(el => el.dataset.letter === letter);
      if (target) target.classList.add("active");
    }

    // ---------- DM overlay (quest node pause) ----------
    const dmOverlay = document.getElementById("dmOverlay");
    const dmClose = document.getElementById("dmClose");
    const dmChar = document.getElementById("dmChar");
    const speechP = document.getElementById("speechP");
    const speechText = document.getElementById("speechText");

    // You can set this later to your actual DM PNG path:
    // dmChar.src = "assets/marketing_alchemist_dm.png";
    // For now leave blank; the slide-in still works.

    function openDM(text){
      dmOverlay.classList.add("active");
      dmOverlay.setAttribute("aria-hidden","false");
      // Put text
      speechP.textContent = text || "Quest node placeholder…";
      fitSpeechText();

      // Shake the character when overlay opens (even if image empty)
      dmChar.classList.remove("shake");
      // Wait for slide transition and then shake
      setTimeout(() => dmChar.classList.add("shake"), 280);
      setTimeout(() => dmChar.classList.remove("shake"), 650);
    }

    function closeDM(){
      dmOverlay.classList.remove("active");
      dmOverlay.setAttribute("aria-hidden","true");
    }

    dmClose.addEventListener("click", closeDM);
    // Also allow tapping outside bubble to close? (optional)
    dmOverlay.addEventListener("click", (e) => {
      // only close if tapping the dim background (not the bubble itself)
      const bubble = document.querySelector(".speechWrap");
      if (!bubble.contains(e.target) && e.target !== dmChar) closeDM();
    });

    // ---------- Speech bubble shrink-to-fit ----------
    function fitSpeechText(){
      // Start large, shrink until it fits in container
      const max = 18;
      const min = 12;
      let size = max;
      speechP.style.fontSize = size + "px";

      // Force layout measurement
      const fits = () => speechText.scrollHeight <= speechText.clientHeight + 1;

      while (!fits() && size > min){
        size -= 1;
        speechP.style.fontSize = size + "px";
      }
    }
    window.addEventListener("resize", () => {
      if (dmOverlay.classList.contains("active")) fitSpeechText();
    });

    // ---------- Modifiers (+) → Shop modal placeholder ----------
    const shopModal = document.getElementById("shopModal");
    const shopClose = document.getElementById("shopClose");
    document.querySelectorAll(".modSlot").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        shopModal.classList.add("active");
        shopModal.setAttribute("aria-hidden","false");
      });
    });
    shopClose.addEventListener("click", ()=>{
      shopModal.classList.remove("active");
      shopModal.setAttribute("aria-hidden","true");
    });
    shopModal.addEventListener("click", (e)=>{
      if (e.target === shopModal){
        shopModal.classList.remove("active");
        shopModal.setAttribute("aria-hidden","true");
      }
    });

    // ---------- Demo buttons (temporary helpers) ----------
    document.getElementById("demoQuest").addEventListener("click", ()=>{
      openDM(
        "Quest Node: The lab lights flicker. You can keep tapping bottles like a gremlin… or you can think for two seconds and win.\n\n(Placeholder text; this will be LLM output later.)"
      );
    });

    document.getElementById("demoBank").addEventListener("click", ()=>{
      bankIdx = (bankIdx + 1) % bankOrder.length;
      setActiveBank(bankOrder[bankIdx]);
    });

    // Default: show grey letters only
    setActiveBank(null);
  </script>
</body>
</html>
